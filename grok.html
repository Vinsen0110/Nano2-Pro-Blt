<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grok Studio</title>
    <link rel="icon" href="https://abs.twimg.com/responsive-web/client-web/icon-ios.b1fc727a.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            950: '#030712',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .custom-input { transition: all 0.2s; }
        .custom-input:focus { border-color: #000; outline: none; box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1); }
        .dark .custom-input:focus { border-color: #fff; box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2); }
        
        .upload-box { background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='8' ry='8' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='8%2c8' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); }
        .dark .upload-box { background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='8' ry='8' stroke='%233F3F46FF' stroke-width='2' stroke-dasharray='8%2c8' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); }
        
        .dropdown-arrow { transition: transform 0.3s ease; }
        .dropdown-open .dropdown-arrow { transform: rotate(180deg); }
        .glow-effect { border-color: #000 !important; color: #000 !important; }
        .dark .glow-effect { border-color: #fff !important; color: #fff !important; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #52525b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #71717a; }
        
        .prompt-box { background-color: #f9fafb; border-radius: 8px; padding: 12px; font-size: 13px; color: #374151; line-height: 1.6; }
        .dark .prompt-box { background-color: #18181b; color: #d1d5db; }
        
        .task-item.selected { background-color: rgba(0, 0, 0, 0.05); border-left-color: #000; }
        .dark .task-item.selected { background-color: rgba(255, 255, 255, 0.1); border-left-color: #fff; }
        
        .tab-btn { position: relative; }
        .tab-btn.active { color: #000; background-color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .dark .tab-btn.active { background-color: #27272a; color: #fff; box-shadow: none; border: 1px solid #3f3f46; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            body { height: auto !important; overflow-y: auto !important; }
            #main-container { flex-direction: column !important; height: auto !important; }
            #left-sidebar { width: 100% !important; border-r: none; border-b: 1px solid #e5e7eb; height: auto !important; }
            #preview-section { height: 400px !important; min-height: 400px !important; }
            #list-section { height: 600px !important; min-height: 500px !important; }
        }
    </style>
</head>
<body class="md:h-screen flex flex-col md:overflow-hidden bg-white text-gray-900 dark:bg-[#000000] dark:text-[#e4e4e7]" onload="initApp()" onclick="closeDropdownOnClickOutside(event)">

   <header class="h-14 border-b border-gray-200 dark:border-[#27272a] bg-white dark:bg-[#000000] flex items-center justify-between px-4 shrink-0 z-20 sticky top-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg overflow-hidden border border-gray-200 shadow-sm shrink-0 bg-black flex items-center justify-center dark:border-gray-700">
                <span class="text-white font-bold text-xl font-mono">X</span>
            </div>
            <span class="font-bold text-lg tracking-tight text-gray-900 dark:text-gray-100 font-mono">Grok Studio</span>
        </div>
        <div class="flex items-center gap-3 text-sm">
            <div class="hidden md:flex items-center gap-2 px-3 py-1 bg-gray-50 dark:bg-[#18181b] border border-gray-200 dark:border-[#27272a] rounded-full text-[10px] font-mono text-gray-500 dark:text-gray-400 select-none mr-2">
                <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                <span id="current-api-display">api.aabao.vip</span>
            </div>
            <button onclick="toggleTheme()" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 dark:hover:bg-[#18181b] transition"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
            <button onclick="openSettings()" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 dark:hover:bg-[#18181b] transition"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative" id="main-container">
        
        <aside id="left-sidebar" class="w-full md:w-[340px] bg-white border-r border-gray-200 dark:bg-[#09090b] dark:border-[#27272a] flex flex-col shrink-0 z-10">
            <div class="p-5 space-y-5 h-full overflow-y-auto">
                
                <div class="relative z-50">
                    <label class="text-xs text-gray-500 font-bold uppercase tracking-wide">模型选择</label>
                    <div class="relative w-full mt-1.5" id="custom-model-dropdown">
                        <input type="hidden" id="model-select" value="grok-imagine-1.0">
                        <div onclick="toggleDropdown(event, 'custom-model-dropdown', 'model-options', 'model-trigger')" id="model-trigger" class="w-full flex justify-between items-center bg-gray-100 dark:bg-[#18181b] border border-transparent dark:border-[#27272a] rounded-lg px-3 py-2 cursor-pointer transition-all hover:bg-gray-200 dark:hover:bg-[#27272a]">
                            <span id="current-model-text" class="text-xs font-bold font-mono text-gray-700 dark:text-gray-300"><i class="fa-solid fa-image mr-2"></i>Grok Image 1.0</span>
                            <i class="fa-solid fa-chevron-down text-[10px] text-gray-500 dropdown-arrow"></i>
                        </div>
                        <div id="model-options" class="hidden absolute top-full left-0 mt-2 w-full bg-white dark:bg-[#18181b] border border-gray-200 dark:border-[#27272a] rounded-xl shadow-xl overflow-hidden z-50 p-1">
                            <div onclick="selectModel('grok-imagine-1.0', 'Grok Image 1.0', 'fa-image')" class="model-option flex items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-[#27272a] group transition bg-gray-100 dark:bg-[#27272a]" data-val="grok-imagine-1.0">
                                <i class="fa-solid fa-image w-5 text-gray-400 group-hover:text-black dark:group-hover:text-white"></i>
                                <span class="text-xs font-bold text-gray-700 dark:text-gray-300 flex-1">Grok Image 1.0</span>
                                <i class="fa-solid fa-check text-black dark:text-white text-xs opacity-100 check-icon"></i>
                            </div>
                            <div onclick="selectModel('grok-imagine-video', 'Grok Video', 'fa-video')" class="model-option flex items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-[#27272a] group transition" data-val="grok-imagine-video">
                                <i class="fa-solid fa-video w-5 text-gray-400 group-hover:text-black dark:group-hover:text-white"></i>
                                <span class="text-xs font-bold text-gray-700 dark:text-gray-300 flex-1">Grok Video</span>
                                <i class="fa-solid fa-check text-black dark:text-white text-xs opacity-0 check-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-xs text-gray-500 font-bold uppercase tracking-wide">参考/垫图 (可选)</label>
                    </div>
                    <div id="upload-area" class="upload-box relative w-full h-28 rounded-xl cursor-pointer flex flex-col items-center justify-center bg-gray-50 dark:bg-[#18181b] hover:bg-gray-100 dark:hover:bg-[#1f1f22] transition group border border-dashed border-gray-300 dark:border-gray-700" onclick="document.getElementById('file-input').click()">
                        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                        <div id="upload-placeholder" class="text-center group-hover:scale-105 transition duration-300">
                            <i class="fa-solid fa-cloud-arrow-up text-xl text-gray-300 dark:text-gray-600 mb-2 group-hover:text-black dark:group-hover:text-white transition"></i>
                            <p class="text-xs text-gray-400 dark:text-gray-500 font-bold">点击上传</p>
                        </div>
                        <img id="preview-img" class="absolute inset-0 w-full h-full object-contain rounded-xl hidden bg-black/50 backdrop-blur-sm transition">
                        <div id="clear-img-btn" onclick="clearImage(event)" class="absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hidden hover:scale-110 transition shadow-lg z-20 cursor-pointer"><i class="fa-solid fa-xmark text-xs"></i></div>
                    </div>
                </div>

                <div class="space-y-2 flex-1">
                    <label class="text-xs text-gray-500 font-bold uppercase tracking-wide">提示词</label>
                    <textarea id="prompt-input" class="w-full h-40 custom-input rounded-xl p-3 text-sm bg-gray-50 border border-gray-200 text-gray-800 dark:bg-[#18181b] dark:border-[#27272a] dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-700 resize-none font-mono leading-relaxed focus:bg-white dark:focus:bg-black" placeholder="描述你想要生成的画面或视频..."></textarea>
                </div>

                <div class="mt-auto space-y-4 pb-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs text-gray-500 font-bold uppercase">比例</label>
                            <div class="relative w-full" id="custom-ratio-dropdown">
                                <input type="hidden" id="ratio-select" value="16:9">
                                <div onclick="toggleDropdown(event, 'custom-ratio-dropdown', 'ratio-options', 'ratio-trigger')" id="ratio-trigger" class="w-full flex justify-between items-center bg-gray-100 dark:bg-[#18181b] border border-transparent dark:border-[#27272a] rounded-lg px-3 py-2.5 cursor-pointer transition-all hover:bg-gray-200 dark:hover:bg-[#27272a]">
                                    <span id="ratio-text" class="text-xs font-bold text-gray-700 dark:text-gray-300">16:9 (横屏)</span>
                                    <i class="fa-solid fa-chevron-down text-[10px] text-gray-500 dropdown-arrow"></i>
                                </div>
                                <div id="ratio-options" class="hidden absolute top-full left-0 mt-2 w-full bg-white dark:bg-[#18181b] border border-gray-200 dark:border-[#27272a] rounded-xl shadow-xl overflow-hidden z-50 p-1">
                                    <div onclick="selectRatio('16:9', '16:9 (横屏)')" class="ratio-opt flex justify-between items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-[#27272a] group transition bg-gray-100 dark:bg-[#27272a]" data-val="16:9">
                                        <span class="text-xs font-bold text-gray-700 dark:text-gray-300">16:9 (横屏)</span>
                                        <i class="fa-solid fa-check text-black dark:text-white text-xs opacity-100 check-icon"></i>
                                    </div>
                                    <div onclick="selectRatio('9:16', '9:16 (竖屏)')" class="ratio-opt flex justify-between items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-[#27272a] group transition" data-val="9:16">
                                        <span class="text-xs font-bold text-gray-700 dark:text-gray-300">9:16 (竖屏)</span>
                                        <i class="fa-solid fa-check text-black dark:text-white text-xs opacity-0 check-icon"></i>
                                    </div>
                                    <div onclick="selectRatio('1:1', '1:1 (方形)')" class="ratio-opt flex justify-between items-center px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-[#27272a] group transition" data-val="1:1">
                                        <span class="text-xs font-bold text-gray-700 dark:text-gray-300">1:1 (方形)</span>
                                        <i class="fa-solid fa-check text-black dark:text-white text-xs opacity-0 check-icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs text-gray-500 font-bold uppercase">时长/数量</label>
                            <div class="relative w-full">
                                <div class="w-full flex justify-between items-center bg-gray-100 dark:bg-[#18181b] border border-transparent dark:border-[#27272a] rounded-lg px-3 py-2.5 opacity-60 cursor-not-allowed">
                                    <span id="duration-display" class="text-xs font-bold text-gray-700 dark:text-gray-300">自动</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="submitTask()" id="generate-btn" class="w-full bg-black hover:bg-gray-800 dark:bg-white dark:hover:bg-gray-200 dark:text-black text-white font-bold py-3.5 rounded-xl transition transform active:scale-[0.98] flex items-center justify-center gap-2 shadow-lg shadow-gray-500/10">
                        <span id="btn-text">⚡ 立即生成</span>
                        <i id="loading-icon" class="fa-solid fa-spinner fa-spin hidden"></i>
                    </button>
                </div>
            </div>
        </aside>

        <main id="right-content" class="w-full md:flex-1 flex flex-col min-w-0 bg-white dark:bg-black transition-colors">
            
            <div id="preview-section" style="height: 60%;" class="min-h-[200px] flex border-b border-gray-200 dark:border-[#27272a] bg-white dark:bg-[#09090b] relative">
                <div class="flex-1 bg-gray-50 dark:bg-[#000] relative flex items-center justify-center overflow-hidden group">
                    
                    <div id="media-container" class="w-full h-full flex items-center justify-center p-4 hidden">
                        <video id="main-player" class="w-full h-full object-contain shadow-2xl rounded-lg hidden" controls autoplay loop playsinline></video>
                        <img id="main-image" class="w-full h-full object-contain shadow-2xl rounded-lg hidden" alt="Result">
                    </div>

                    <div id="preview-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 z-10">
                        <div class="w-20 h-20 bg-white dark:bg-[#18181b] rounded-full flex items-center justify-center mb-4 shadow-sm border border-gray-100 dark:border-[#27272a]">
                            <i class="fa-solid fa-wand-magic-sparkles text-3xl text-gray-300 dark:text-gray-600"></i>
                        </div>
                        <p class="text-sm font-medium font-mono text-gray-500">Grok Imagine</p>
                    </div>
                    
                    <div id="preview-loading" class="absolute inset-0 bg-black/90 z-20 flex flex-col items-center justify-center text-white hidden">
                        <div class="text-center">
                            <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4"></i>
                            <p class="text-lg font-bold">正在思考...</p>
                            <p class="text-sm text-gray-400 mt-2 font-mono" id="loading-status-text">Processing...</p>
                        </div>
                    </div>
                </div>
                
                <div class="w-[300px] bg-white dark:bg-[#09090b] border-l border-gray-200 dark:border-[#27272a] flex flex-col overflow-y-auto shrink-0 hidden md:flex">
                    <div class="p-6 space-y-6">
                        <div class="flex items-center gap-3">
                            <div id="status-badge" class="px-2.5 py-1 rounded text-xs font-bold bg-gray-100 text-gray-500">READY</div>
                            <span class="text-xs text-gray-400 ml-auto" id="detail-date">-</span>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">PROMPT</p>
                            <div class="prompt-box select-text"><p id="detail-prompt" class="break-words font-mono text-xs">(暂无内容)</p></div>
                        </div>
                        <div class="mt-auto">
                            <button id="download-btn" onclick="triggerDownload()" class="w-full border border-gray-200 dark:border-[#27272a] hover:bg-gray-50 dark:hover:bg-[#18181b] text-gray-700 dark:text-gray-300 font-bold py-3 rounded-lg transition flex items-center justify-center gap-2 pointer-events-none opacity-50">
                                <i class="fa-solid fa-download"></i> <span id="dl-btn-text">下载资源</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="list-section" class="flex-1 flex flex-col min-h-0 bg-white dark:bg-[#09090b]">
                <div class="h-10 border-b border-gray-200 dark:border-[#27272a] flex items-center justify-between px-6 shrink-0 bg-gray-50 dark:bg-[#09090b]">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">生成历史</span>
                    <button onclick="clearHistory()" class="text-xs text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div id="task-list" class="flex-1 overflow-y-auto p-0">
                    </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-[#18181b] p-6 rounded-2xl w-[400px] shadow-2xl border border-gray-200 dark:border-[#27272a]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold dark:text-white">API 配置</h3>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1.5">API 地址</label>
                    <input type="text" id="setting-url" class="w-full bg-gray-50 dark:bg-[#09090b] border border-gray-200 dark:border-[#27272a] rounded-lg p-2.5 text-sm dark:text-white font-mono" value="https://api.aabao.vip">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1.5">API Key</label>
                    <input type="password" id="setting-key" class="w-full bg-gray-50 dark:bg-[#09090b] border border-gray-200 dark:border-[#27272a] rounded-lg p-2.5 text-sm dark:text-white font-mono" placeholder="sk-...">
                </div>
                <button onclick="saveSettings()" class="w-full bg-black dark:bg-white text-white dark:text-black font-bold py-2.5 rounded-lg">保存</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_API_URL = "https://api.aabao.vip";
        let taskList = [];
        let pollingInterval = null;
        let activeTaskId = null;
        let currentImageBase64 = null;

        function initApp() {
            loadSettings();
            loadTheme();
            loadHistory();
            startPolling();
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('grok_theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        }

        function loadTheme() {
            if (localStorage.getItem('grok_theme') === 'dark' || (!localStorage.getItem('grok_theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').className = 'fa-solid fa-moon';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-icon').className = 'fa-solid fa-sun';
            }
        }

        function toggleDropdown(e, c, o, t) {
            e.stopPropagation();
            document.getElementById(c).classList.toggle('dropdown-open');
            document.getElementById(o).classList.toggle('hidden');
        }

        function closeDropdownOnClickOutside(e) {
            ['custom-model-dropdown', 'custom-ratio-dropdown'].forEach(id => {
                const el = document.getElementById(id);
                if (el && !el.contains(e.target)) {
                    el.classList.remove('dropdown-open');
                    el.querySelector('[id$="-options"]').classList.add('hidden');
                }
            });
        }

        function selectModel(val, text, iconClass) {
            document.getElementById('model-select').value = val;
            document.getElementById('current-model-text').innerHTML = `<i class="fa-solid ${iconClass} mr-2"></i>${text}`;
            document.querySelectorAll('.model-option').forEach(opt => {
                const check = opt.querySelector('.check-icon');
                if (opt.dataset.val === val) {
                    check.classList.replace('opacity-0', 'opacity-100');
                    opt.classList.add('bg-gray-100', 'dark:bg-[#27272a]');
                } else {
                    check.classList.replace('opacity-100', 'opacity-0');
                    opt.classList.remove('bg-gray-100', 'dark:bg-[#27272a]');
                }
            });
            document.getElementById('model-options').classList.add('hidden');
        }

        function selectRatio(val, text) {
            document.getElementById('ratio-select').value = val;
            document.getElementById('ratio-text').innerText = text;
            document.querySelectorAll('.ratio-opt .check-icon').forEach((icon, idx) => {
                const parent = icon.parentElement;
                if(parent.dataset.val === val) icon.classList.replace('opacity-0', 'opacity-100');
                else icon.classList.replace('opacity-100', 'opacity-0');
            });
            document.getElementById('ratio-options').classList.add('hidden');
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                currentImageBase64 = evt.target.result;
                document.getElementById('preview-img').src = currentImageBase64;
                document.getElementById('preview-img').classList.remove('hidden');
                document.getElementById('upload-placeholder').classList.add('hidden');
                document.getElementById('clear-img-btn').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearImage(e) {
            e.stopPropagation();
            document.getElementById('file-input').value = '';
            document.getElementById('preview-img').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('clear-img-btn').classList.add('hidden');
            currentImageBase64 = null;
        }

        async function submitTask() {
            const key = localStorage.getItem('grok_api_key');
            const url = localStorage.getItem('grok_api_url') || DEFAULT_API_URL;
            if (!key) { openSettings(); return; }

            const prompt = document.getElementById('prompt-input').value.trim();
            if (!prompt) { alert("请输入提示词"); return; }

            const model = document.getElementById('model-select').value;
            const ratio = document.getElementById('ratio-select').value;
            
            const btn = document.getElementById('generate-btn');
            const icon = document.getElementById('loading-icon');
            const btnText = document.getElementById('btn-text');

            btn.disabled = true;
            btn.classList.add('opacity-70');
            icon.classList.remove('hidden');
            btnText.innerText = "提交任务...";

            try {
                // 根据文档截图修改：统一使用 /v1/videos 接口
                const endpoint = '/v1/videos'; 
                
                // 统一构造 Payload
                const payload = {
                    model: model,
                    prompt: prompt,
                    aspect_ratio: ratio,
                    ...(currentImageBase64 ? { images: [currentImageBase64] } : {})
                };

                const res = await fetch(`${url}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error?.message || "请求失败");

                const now = Date.now();
                // 现在所有模型都统一返回 Task ID 进行轮询
                const taskId = data.id || data.task_id;

                if (taskId) {
                    const newTask = {
                        id: taskId,
                        prompt: prompt,
                        model: model,
                        // 根据模型名简单标记类型，但处理逻辑一致
                        type: model.includes('video') ? 'video' : 'image', 
                        status: 'IN_PROGRESS',
                        startTime: now
                    };
                    taskList.unshift(newTask);
                    saveHistory();
                    renderTaskList();
                    previewTask(newTask.id);
                    checkTaskStatus(taskId); 
                } else {
                    alert("API 未返回 Task ID");
                }

            } catch (e) {
                alert("错误: " + e.message);
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-70');
                icon.classList.add('hidden');
                btnText.innerText = "⚡ 立即生成";
            }
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(() => {
                const pendings = taskList.filter(t => t.status !== 'SUCCESS' && t.status !== 'FAILURE');
                pendings.forEach(t => checkTaskStatus(t.id));
            }, 3000);
        }

        async function checkTaskStatus(id) {
            const task = taskList.find(t => t.id === id);
            if (!task) return;
            const key = localStorage.getItem('grok_api_key');
            const url = localStorage.getItem('grok_api_url') || DEFAULT_API_URL;
            
            try {
                // 根据文档截图修改：统一使用 /v1/videos/{task_id} 接口
                const res = await fetch(`${url}/v1/videos/${id}`, {
                    headers: { 'Authorization': `Bearer ${key}` }
                });
                if (!res.ok) return;
                
                const data = await res.json();
                let status = data.status || data.data?.status || 'IN_PROGRESS';
                status = status.toUpperCase();
                
                if (status === 'SUCCESS' || status === 'SUCCEEDED') {
                    task.status = 'SUCCESS';
                    const vUrl = data.url || data.video_url || data.data?.video_url || data.data?.url || data.output;
                    if (vUrl) task.url = vUrl;
                    task.finishTime = Date.now();
                    saveHistory();
                    renderTaskList();
                    if (activeTaskId === id) previewTask(id);
                } else if (status === 'FAILED' || status === 'FAILURE') {
                    task.status = 'FAILURE';
                    saveHistory();
                    renderTaskList();
                    if (activeTaskId === id) previewTask(id);
                }
            } catch (e) { console.error(e); }
        }

        function previewTask(id) {
            activeTaskId = id;
            const task = taskList.find(t => t.id === id);
            if (!task) return;

            renderTaskList();

            const placeholder = document.getElementById('preview-placeholder');
            const loading = document.getElementById('preview-loading');
            const container = document.getElementById('media-container');
            const videoEl = document.getElementById('main-player');
            const imageEl = document.getElementById('main-image');
            
            document.getElementById('detail-prompt').innerText = task.prompt;
            document.getElementById('detail-date').innerText = new Date(task.startTime).toLocaleTimeString();
            const badge = document.getElementById('status-badge');
            const dlBtn = document.getElementById('download-btn');

            placeholder.classList.add('hidden');

            if (task.status === 'SUCCESS') {
                loading.classList.add('hidden');
                container.classList.remove('hidden');
                
                badge.className = "px-2.5 py-1 rounded text-xs font-bold bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300";
                badge.innerText = "COMPLETED";
                dlBtn.classList.remove('pointer-events-none', 'opacity-50');
                
                // 兼容：虽然接口是 video，但如果返回的是图片格式链接，用 img 标签
                const isImgUrl = task.url && (task.url.includes('.png') || task.url.includes('.jpg') || task.url.includes('.webp'));
                
                if (isImgUrl) {
                    videoEl.classList.add('hidden');
                    videoEl.pause();
                    imageEl.src = task.url;
                    imageEl.classList.remove('hidden');
                } else {
                    imageEl.classList.add('hidden');
                    videoEl.src = task.url;
                    videoEl.classList.remove('hidden');
                    videoEl.play().catch(e=>{});
                }
            } else if (task.status === 'FAILURE') {
                loading.classList.add('hidden');
                container.classList.add('hidden');
                badge.className = "px-2.5 py-1 rounded text-xs font-bold bg-red-100 text-red-600";
                badge.innerText = "FAILED";
                placeholder.classList.remove('hidden');
                placeholder.querySelector('p').innerText = "生成失败";
            } else {
                loading.classList.remove('hidden');
                container.classList.add('hidden');
                badge.className = "px-2.5 py-1 rounded text-xs font-bold bg-blue-100 text-blue-600";
                badge.innerText = "PROCESSING";
            }
        }

        function renderTaskList() {
            const container = document.getElementById('task-list');
            container.innerHTML = '';
            taskList.forEach(task => {
                const isActive = activeTaskId === task.id;
                const div = document.createElement('div');
                div.className = `task-item flex items-center gap-4 px-6 py-4 border-b border-gray-100 dark:border-[#27272a] cursor-pointer transition-colors hover:bg-gray-50 dark:hover:bg-[#121214] ${isActive ? 'selected' : 'border-l-4 border-l-transparent'}`;
                div.onclick = () => previewTask(task.id);
                
                let iconHtml = '';
                if (task.status === 'SUCCESS') {
                    if (task.url && (task.url.includes('.png') || task.url.includes('.jpg'))) {
                         iconHtml = `<div class="w-12 h-12 bg-gray-100 rounded bg-cover bg-center border border-gray-200" style="background-image: url('${task.url}')"></div>`;
                    } else {
                        iconHtml = `<div class="w-12 h-12 bg-black rounded flex items-center justify-center"><i class="fa-solid fa-film text-white"></i></div>`;
                    }
                } else if (task.status === 'FAILURE') {
                    iconHtml = `<div class="w-12 h-12 bg-red-50 rounded flex items-center justify-center"><i class="fa-solid fa-xmark text-red-400"></i></div>`;
                } else {
                    iconHtml = `<div class="w-12 h-12 bg-gray-50 rounded flex items-center justify-center"><i class="fa-solid fa-spinner fa-spin text-gray-400"></i></div>`;
                }

                div.innerHTML = `
                    ${iconHtml}
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[10px] font-bold uppercase ${task.status==='SUCCESS'?'text-green-500':'text-gray-500'}">${task.model.replace('grok-imagine-', '').toUpperCase()}</span>
                            <span class="text-[10px] text-gray-400 font-mono">${new Date(task.startTime).toLocaleTimeString()}</span>
                        </div>
                        <p class="text-xs text-gray-600 dark:text-gray-300 truncate font-medium">${task.prompt}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function triggerDownload() {
            const task = taskList.find(t => t.id === activeTaskId);
            if (task && task.url) {
                const a = document.createElement('a');
                a.href = task.url;
                const ext = task.url.includes('.mp4') ? 'mp4' : 'png';
                a.download = `grok_${task.id}.${ext}`;
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        function saveSettings() {
            localStorage.setItem('grok_api_key', document.getElementById('setting-key').value.trim());
            let url = document.getElementById('setting-url').value.trim();
            if(url.endsWith('/')) url = url.slice(0, -1);
            localStorage.setItem('grok_api_url', url);
            document.getElementById('current-api-display').innerText = new URL(url).hostname;
            closeSettings();
        }

        function loadSettings() {
            document.getElementById('setting-key').value = localStorage.getItem('grok_api_key') || '';
            const url = localStorage.getItem('grok_api_url') || DEFAULT_API_URL;
            document.getElementById('setting-url').value = url;
            try { document.getElementById('current-api-display').innerText = new URL(url).hostname; } catch(e){}
        }

        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

        function saveHistory() { localStorage.setItem('grok_history_v2', JSON.stringify(taskList)); }
        function loadHistory() { 
            const s = localStorage.getItem('grok_history_v2');
            if(s) { taskList = JSON.parse(s); renderTaskList(); }
        }
        function clearHistory() { 
            if(confirm("确定清空历史记录吗？")) {
                taskList = []; saveHistory(); renderTaskList();
                document.getElementById('media-container').classList.add('hidden');
                document.getElementById('preview-placeholder').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>